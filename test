import { mount } from '@vue/test-utils'
import { describe, it, expect, beforeEach } from 'vitest'
import { createTestingPinia } from '@pinia/testing'
import mckitui from 'mc-kit-ui/src/plugins/mc-kit-ui'
import dayjs from '@/plugins/dayjs'
import DocumentsVisualiserExport from '../DocumentsVisualiserExport.vue'
import exportsSucces from '~/tests/__fixtures__/facturation/api-facturation-exports-succes.json'

describe('DocumentsVisualiserExport.vue', () => {
  let wrapper

  const ligneDonnee =exportsSucces.items[0]

  beforeEach(() => {
    wrapper = mount(DocumentsVisualiserExport, {
      global: {
        plugins: [mckitui, dayjs, createTestingPinia()],
        stubs: {
          McDialogbox: true,
          McCard: true,
          McAccordion: true,
        },
      },
      props: {
        documentsVisualiserExportVisible: true,
        documentsVisualiserExportLigneDonne: ligneDonnee,
      },
    })
  })

  it('affiche le dialog quand documentsVisualiserExportVisible est true', () => {
    const dialog = wrapper.findComponent({name: 'mc-dialogbox'})
    expect(dialog.exists()).toBe(true)
  })

  it('contient les selects et le téléchargement .zip', () => {
    const selectDocs = wrapper.findComponent('[test-id="test_dvedsd"]')
    const selectPartenaires = wrapper.findComponent('[test-id="test_dvedsp"]')
    const selectDestinataires = wrapper.findComponent('[test-id="test_dvedsdest"]')
    const downloadZip = wrapper.findComponent('[test-id="test_dvedtz"]')

    expect(selectDocs.exists()).toBe(true)
    expect(selectPartenaires.exists()).toBe(true)
    expect(selectDestinataires.exists()).toBe(true)
    expect(downloadZip.exists()).toBe(true)
  })

  it('émet "documentVisualiserExportFermerEmise" quand on ferme le dialog', async () => {
    const dialog = wrapper.findComponent('[data-test-id="dialogbox"]')
    await dialog.vm.$emit('close-dialogbox')

    const emitted = wrapper.emitted('documentVisualiserExportFermerEmise')
    expect(emitted).toHaveLength(1)
    expect(emitted[0][0]).toBe(false)
  })

  it('n’affiche pas la section de téléchargement quand archive est absente', async () => {
    await wrapper.setProps({
      documentsVisualiserExportLigneDonne: {
        ...ligneDonnee,
        archive: null,
      },
    })

    expect(wrapper.find('[test-id="test_dvedtz"]').exists()).toBe(false)
  })

  it('calcule correctement les options des selects', () => {
    const vm = wrapper.vm

    expect(vm.comp__documentsVisualiserExport_OptionsDocuments).toEqual([
      { label: 'Doc A', value: 1 },
    ])
    expect(vm.comp__documentsVisualiserExport_OptionsPartenaires).toEqual([
      { label: 'Partenaire X', value: 2 },
    ])
    expect(vm.comp__documentsVisualiserExport_OptionsDestinataires).toEqual([
      { label: 'John Doe', value: 3 },
    ])
  })
})
