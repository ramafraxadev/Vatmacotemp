import { mount } from '@vue/test-utils'
import { describe, it, expect, beforeEach } from 'vitest'
import { createTestingPinia } from '@pinia/testing'
import mckitui from 'mc-kit-ui/src/plugins/mc-kit-ui'
import dayjs from '@/plugins/dayjs'
import DocumentsVisualiserExport from '../DocumentsVisualiserExport.vue'

// fixture adaptée au format attendu par normalizeToOption()
const ligneDonneeMock = {
  documents: [{ id: 1, name: 'Doc A' }],
  partenaires: [{ id: 2, name: 'Partenaire X' }],
  destinataires: [{ id: 3, name: 'John Doe' }],
  archive: true,
}

describe('DocumentsVisualiserExport.vue', () => {
  let wrapper

  beforeEach(() => {
    wrapper = mount(DocumentsVisualiserExport, {
      global: {
        plugins: [mckitui, dayjs, createTestingPinia()],
        stubs: {
          // Stub seulement les sous-composants non essentiels
          DocumentsInformationDocument: true,
          DocumentsActionsDocument: true,
          DocumentsPartenaireDestinataireSelect: true,
          DocumentsTelechargementZip: true,
        },
      },
      props: {
        documentsVisualiserExportVisible: true,
        documentsVisualiserExportLigneDonne: ligneDonneeMock,
      },
    })
  })

  it('affiche le dialog quand documentsVisualiserExportVisible est true', () => {
    const dialog = wrapper.findComponent({ name: 'mc-dialogbox' })
    expect(dialog.exists()).toBe(true)
  })

  it('contient les selects et le téléchargement .zip', () => {
    // comme on stub les sous-composants, on vérifie leur présence par tag
    expect(wrapper.findComponent({ name: 'documents-partenaire-destinataire-select' }).exists()).toBe(true)
    expect(wrapper.findComponent({ name: 'documents-telechargement-zip' }).exists()).toBe(true)
  })

  it('émet "documentVisualiserExportFermerEmise" quand on ferme le dialog', async () => {
    const dialog = wrapper.findComponent({ name: 'mc-dialogbox' })
    await dialog.vm.$emit('close-dialogbox')

    const emitted = wrapper.emitted('documentVisualiserExportFermerEmise')
    expect(emitted).toBeTruthy()
    expect(emitted[0]).toEqual([false])
  })

  it('n’affiche pas la section de téléchargement quand archive est absente', async () => {
    await wrapper.setProps({
      documentsVisualiserExportLigneDonne: {
        ...ligneDonneeMock,
        archive: null,
      },
    })

    expect(wrapper.findComponent({ name: 'documents-telechargement-zip' }).exists()).toBe(false)
  })

  it('calcule correctement les options des selects', () => {
    const vm = wrapper.vm
    expect(vm.comp__documentsVisualiserExport_OptionsDocuments).toEqual([
      { label: 'Doc A', value: 1 },
    ])
    expect(vm.comp__documentsVisualiserExport_OptionsPartenaires).toEqual([
      { label: 'Partenaire X', value: 2 },
    ])
    expect(vm.comp__documentsVisualiserExport_OptionsDestinataires).toEqual([
      { label: 'John Doe', value: 3 },
    ])
  })
})
