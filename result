// app/components/facturation/exports/__tests__/DocumentsTelechargementZip.spec.js
import { mount, flushPromises } from '@vue/test-utils'
import { describe, it, beforeEach, afterEach, expect, vi } from 'vitest'
import { createPinia, setActivePinia } from 'pinia'

import mckitui from 'mc-kit-ui/src/plugins/mc-kit-ui'
import dayjs from '@/plugins/dayjs'
import store from '@/store/store'
import router from '~/tests/utils/test-router'

import { useFacturationDocumentsStore } from '@/stores/facturation/store-facturation-documents'
import DocumentsTelechargementZip from '../DocumentsTelechargementZip.vue'

const mockDonnee = {
  id: 1,
  archive: 'Archive_Test_123.zip',
}

describe('DocumentsTelechargementZip.vue', () => {
  let wrapper
  let mockNotify
  let spyTelecharger

  beforeEach(async () => {
    // Pinia actif pour que useFacturationDocumentsStore() fonctionne
    setActivePinia(createPinia())

    // Notifications injectées
    mockNotify = { error: vi.fn(), success: vi.fn() }

    // Monte le composant avec TOUS les plugins demandés
    wrapper = mount(DocumentsTelechargementZip, {
      props: {
        documentsTelechargementZipDonnee: mockDonnee,
      },
      global: {
        plugins: [mckitui, dayjs, store, router],
        provide: { $mcNotify: mockNotify },
        // ne pas stub mc-button / mc-link, on a besoin des events personnalisés
      },
    })

    // IMPORTANT: récupère le même store instance que le composant
    const storeFD = useFacturationDocumentsStore()
    spyTelecharger = vi
      .spyOn(storeFD, 'action__facturationDocuments_telechargerArchive')
      .mockResolvedValue()
    await flushPromises()
  })

  afterEach(() => {
    vi.clearAllMocks()
  })

  it('affiche le nom de l’archive', () => {
    expect(wrapper.html()).toContain('Archive_Test_123.zip')
  })

  it('déclenche le téléchargement au clic sur "Télécharger"', async () => {
    const btnDownload = wrapper.findComponent('[test-id="test_dtzt"]')
    // mc-button émet "button-click"
    await btnDownload.vm.$emit('button-click')
    await flushPromises()

    expect(spyTelecharger).toHaveBeenCalledTimes(1)
    expect(spyTelecharger).toHaveBeenCalledWith('Archive_Test_123.zip')
  })

  it('émet "DocumentsTelechargementZipAnnulerEmise" au clic sur "Annuler"', async () => {
    const btnCancel = wrapper.findComponent('[test-id="test_dtza"]')
    await btnCancel.vm.$emit('button-click')

    const emitted = wrapper.emitted('DocumentsTelechargementZipAnnulerEmise')
    expect(emitted).toBeTruthy()
    expect(emitted[0]).toEqual([])
  })

  it('notifie une erreur si le téléchargement échoue', async () => {
    spyTelecharger.mockRejectedValueOnce(new Error('Erreur de téléchargement'))

    const btnDownload = wrapper.findComponent('[test-id="test_dtzt"]')
    await btnDownload.vm.$emit('button-click')
    await flushPromises()

    expect(mockNotify.error).toHaveBeenCalledWith('Erreur de téléchargement')
  })
})
